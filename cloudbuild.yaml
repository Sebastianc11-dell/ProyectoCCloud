substitutions:
  _REGION: us-central1
  _REPOSITORY: pricewatch
  _BACKEND_SERVICE: pricewatch-api
  _FRONTEND_SERVICE: pricewatch-web
  _DB_HOST: 127.0.0.1
  _DB_PORT: "3306"
  _DB_NAME: price_monitor
  _DB_USER: master
  _DB_PASS: changeme
  _TWILIO_ACCOUNT_SID: ""
  _TWILIO_AUTH_TOKEN: ""
  _TWILIO_FROM_NUMBER: ""
  _TWILIO_MESSAGING_SERVICE_SID: ""
  _RAPIDAPI_KEY: ""
  _RAPIDAPI_HOST: amazon-product-info2.p.rapidapi.com

steps:
  - name: gcr.io/cloud-builders/docker
    args:
      [
        "build",
        "-t",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/backend",
        "./backend",
      ]

  - name: gcr.io/cloud-builders/docker
    args:
      [
        "push",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/backend",
      ]

  - name: gcr.io/cloud-builders/docker
    args:
      [
        "build",
        "-t",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/frontend",
        "./front",
      ]

  - name: gcr.io/cloud-builders/docker
    args:
      [
        "push",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/frontend",
      ]

  - name: gcr.io/cloud-builders/gcloud
    args:
      [
        "run",
        "deploy",
        "$_BACKEND_SERVICE",
        "--image",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/backend",
        "--region",
        "$_REGION",
        "--allow-unauthenticated",
        "--set-env-vars",
        "PORT=8080,DB_HOST=$_DB_HOST,DB_PORT=$_DB_PORT,DB_NAME=$_DB_NAME,DB_USER=$_DB_USER,DB_PASS=$_DB_PASS,TWILIO_ACCOUNT_SID=$_TWILIO_ACCOUNT_SID,TWILIO_AUTH_TOKEN=$_TWILIO_AUTH_TOKEN,TWILIO_FROM_NUMBER=$_TWILIO_FROM_NUMBER,TWILIO_MESSAGING_SERVICE_SID=$_TWILIO_MESSAGING_SERVICE_SID,RAPIDAPI_KEY=$_RAPIDAPI_KEY,RAPIDAPI_HOST=$_RAPIDAPI_HOST",
      ]

  - name: gcr.io/cloud-builders/gcloud
    args:
      [
        "run",
        "deploy",
        "$_FRONTEND_SERVICE",
        "--image",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/frontend",
        "--region",
        "$_REGION",
        "--allow-unauthenticated",
        "--port",
        "8080",
      ]

images:
  - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/backend"
  - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPOSITORY/frontend"
